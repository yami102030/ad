<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBC 自動排班管理系統</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.20/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
        }
    }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .schedule-table th { @apply px-3 py-3 bg-slate-100 text-slate-600 text-[10px] md:text-xs font-bold uppercase tracking-wider text-left border-b; }
        .schedule-table td { @apply px-3 py-2 text-xs md:text-sm text-slate-700 border-b border-slate-50; }
        
        .name-tag { 
            @apply inline-flex items-center bg-white border border-slate-200 px-3 py-1 rounded shadow-sm text-[11px] font-medium cursor-pointer select-none transition-all;
        }
        .name-tag:hover { @apply border-indigo-400 bg-indigo-50 text-indigo-700 ring-2 ring-indigo-100; }
        .name-tag.dragging { @apply opacity-40 border-dashed border-indigo-500 bg-indigo-100; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-step { animation: fadeIn 0.4s ease-out; }
        
        .modal-backdrop { @apply fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in fade-in duration-200; }
        .modal-content { @apply bg-white w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden animate-in zoom-in duration-300; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Settings, Play, Save, CheckCircle2, AlertCircle, Users, ChevronRight, LayoutList, RefreshCw, Trash2, Info, AlertTriangle, GripVertical, X, UserCheck, Search, Clock, HandHeart } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        const SUPABASE_URL = "https://jcepavwocdujoeoqxvsd.supabase.co";
        const SUPABASE_KEY = "sb_publishable_Tj2n8e3yY1HyvaFzXRyO_w_PWrVFB7E"; 
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const ROLES_CONFIG = [
            { name: '司會', count: 1 },
            { name: '執事輪值', count: 1 },
            { name: '接待', count: 4 },
            { name: '收奉獻', count: 4 },
            { name: 'PPT', count: 1 },
            { name: '新朋友關懷', count: 3 }
        ];
        const COMMUNION_ROLE = { name: '主餐', count: 6 };

        function App() {
            const [step, setStep] = useState(1); 
            const [year, setYear] = useState(new Date().getFullYear());
            const [quarter, setQuarter] = useState(Math.ceil((new Date().getMonth() + 1) / 3));
            const [sessionsToSchedule, setSessionsToSchedule] = useState(['第一堂', '第二堂']);
            
            const [dbData, setDbData] = useState({ members: [], positions: [], memberPositions: [], existingSchedules: [] });
            const [isLoading, setIsLoading] = useState(true);
            const [generatedDraft, setGeneratedDraft] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [showClearModal, setShowClearModal] = useState(false);
            
            // 換班編輯相關 State
            const [activeSlot, setActiveSlot] = useState(null); // { temp_id, date, session, posId, posName, currentMemberId }
            const [draggedItem, setDraggedItem] = useState(null);

            useEffect(() => { fetchInitialData(); }, []);

            const fetchInitialData = async () => {
                setIsLoading(true);
                try {
                    const [{ data: members }, { data: positions }, { data: memberPositions }, { data: schedules }] = await Promise.all([
                        supabase.from('members').select('*'),
                        supabase.from('positions').select('*'),
                        supabase.from('member_positions').select('*'),
                        supabase.from('schedules').select('*')
                    ]);
                    setDbData({ members: members || [], positions: positions || [], memberPositions: memberPositions || [], existingSchedules: schedules || [] });
                } catch (err) { setErrorMsg('讀取資料庫失敗。'); } finally { setIsLoading(false); }
            };

            // 統計目前的服事次數 (包含既有的與草稿中的)
            const currentUsageCount = useMemo(() => {
                const counts = {};
                dbData.members.forEach(m => counts[m.id] = 0);
                dbData.existingSchedules.forEach(s => { if (counts[s.member_id] !== undefined) counts[s.member_id]++; });
                generatedDraft.forEach(d => { if (counts[d.member_id] !== undefined) counts[d.member_id]++; });
                return counts;
            }, [dbData.members, dbData.existingSchedules, generatedDraft]);

            const getSundaysInQuarter = (y, q) => {
                const sundays = [];
                const startMonth = (q - 1) * 3;
                let d = new Date(y, startMonth, 1);
                while (d.getDay() !== 0) d.setDate(d.getDate() + 1);
                while (d.getMonth() >= startMonth && d.getMonth() < startMonth + 3) {
                    sundays.push(new Date(d));
                    d.setDate(d.getDate() + 7);
                }
                return sundays;
            };

            const formatDate = (date) => {
                const offset = date.getTimezoneOffset() * 60000;
                return (new Date(date - offset)).toISOString().split('T')[0];
            };

            const runAutoSchedule = () => {
                const sundays = getSundaysInQuarter(year, quarter);
                const draft = [];
                const usage = {};
                dbData.members.forEach(m => usage[m.id] = 0);
                dbData.existingSchedules.forEach(s => { if (usage[s.member_id] !== undefined) usage[s.member_id]++; });

                sundays.forEach(sunday => {
                    const dateStr = formatDate(sunday);
                    const isFirstSundayOfMonth = sunday.getDate() <= 7;
                    sessionsToSchedule.forEach(sessionName => {
                        const busyInSession = new Set(); 
                        let roles = [...ROLES_CONFIG];
                        if (isFirstSundayOfMonth && sessionName === '第一堂') {
                            roles = [ROLES_CONFIG[0], ROLES_CONFIG[1], ROLES_CONFIG[2], ROLES_CONFIG[3], COMMUNION_ROLE, ROLES_CONFIG[4], ROLES_CONFIG[5]];
                        }
                        roles.forEach(roleReq => {
                            const posId = dbData.positions.find(p => p.name.trim() === roleReq.name)?.id;
                            if (!posId) return;
                            const eligibleIds = dbData.memberPositions.filter(mp => mp.position_id === posId).map(mp => mp.member_id);
                            let candidates = dbData.members.filter(m => eligibleIds.includes(m.id) && !busyInSession.has(m.id) && !(m.unavailable_dates && m.unavailable_dates.includes(dateStr)) && (m.availability_status !== '暫停服事' && m.availability_status !== '休息'));
                            candidates = candidates.filter(m => {
                                if (!m.preferred_session || m.preferred_session === '皆可') return true;
                                if (sessionName === '第一堂' && m.preferred_session.includes('1')) return true;
                                if (sessionName === '第二堂' && m.preferred_session.includes('2')) return true;
                                return true;
                            });
                            candidates.sort((a, b) => usage[a.id] - usage[b.id]);
                            for (let i = 0; i < roleReq.count; i++) {
                                if (candidates[i]) {
                                    const m = candidates[i];
                                    draft.push({
                                        temp_id: `${dateStr}_${sessionName}_${posId}_${i}_${Math.random()}`,
                                        service_date: dateStr,
                                        session: sessionName,
                                        member_id: m.id,
                                        position_id: posId,
                                        _memberName: m.name,
                                        _positionName: roleReq.name
                                    });
                                    busyInSession.add(m.id);
                                    usage[m.id]++;
                                }
                            }
                        });
                    });
                });
                setGeneratedDraft(draft);
                setStep(2);
            };

            // 取得推薦替代人選
            const getRecommendations = (slot) => {
                if (!slot) return [];
                const { service_date, session, position_id, member_id } = slot;
                
                // 1. 找出有此崗位資格的人
                const eligibleIds = dbData.memberPositions.filter(mp => mp.position_id === position_id).map(mp => mp.member_id);
                
                // 2. 找出該堂別已經有服事的人 (避免分身)
                const busyInThisSession = new Set(generatedDraft.filter(d => d.service_date === service_date && d.session === session).map(d => d.member_id));

                return dbData.members
                    .filter(m => {
                        if (m.id === member_id) return false; // 排除自己
                        if (!eligibleIds.includes(m.id)) return false; // 排除沒資格的人
                        if (busyInThisSession.has(m.id)) return false; // 排除該時段已有班的人
                        if (m.availability_status === '暫停服事' || m.availability_status === '休息') return false; // 排除休息中
                        if (m.unavailable_dates && m.unavailable_dates.includes(service_date)) return false; // 排除請假
                        return true;
                    })
                    .map(m => ({
                        ...m,
                        usage: currentUsageCount[m.id] || 0
                    }))
                    .sort((a, b) => a.usage - b.usage); // 優先推薦服事次數少的人
            };

            const replaceMember = (newMember) => {
                if (!activeSlot || !newMember) return;
                setGeneratedDraft(prev => prev.map(d => 
                    d.temp_id === activeSlot.temp_id 
                    ? { ...d, member_id: newMember.id, _memberName: newMember.name } 
                    : d
                ));
                setActiveSlot(null);
            };

            const handleDragStart = (e, item) => {
                setDraggedItem(item);
                e.currentTarget.classList.add('dragging');
            };

            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('dragging');
                setDraggedItem(null);
            };

            const handleDrop = (e, targetDate, targetSession, targetPosName, targetIdx) => {
                e.preventDefault();
                if (!draggedItem) return;
                if (draggedItem.service_date !== targetDate || draggedItem.session !== targetSession || draggedItem._positionName !== targetPosName) return;

                setGeneratedDraft(prev => {
                    const newDraft = [...prev];
                    const group = newDraft.filter(d => d.service_date === targetDate && d.session === targetSession && d._positionName === targetPosName);
                    const sourceIdxInDraft = newDraft.findIndex(d => d.temp_id === draggedItem.temp_id);
                    const targetIdxInDraft = newDraft.findIndex(d => d.temp_id === group[targetIdx].temp_id);
                    const temp = newDraft[sourceIdxInDraft];
                    newDraft[sourceIdxInDraft] = newDraft[targetIdxInDraft];
                    newDraft[targetIdxInDraft] = temp;
                    return newDraft;
                });
            };

            const saveToDatabase = async () => {
                setIsSaving(true);
                try {
                    const sundays = getSundaysInQuarter(year, quarter);
                    const startDate = formatDate(sundays[0]);
                    const endDate = formatDate(sundays[sundays.length - 1]);
                    const { error: delError } = await supabase.from('schedules').delete().gte('service_date', startDate).lte('service_date', endDate).in('session', sessionsToSchedule); 
                    if (delError) throw delError;
                    const insertPayload = generatedDraft.map(d => ({ service_date: d.service_date, session: d.session, member_id: d.member_id, position_id: d.position_id }));
                    await supabase.from('schedules').insert(insertPayload);
                    setStep(3);
                } catch (err) { setErrorMsg('儲存失敗。'); } finally { setIsSaving(false); }
            };

            const renderStep1 = () => (
                <div className="space-y-6 animate-step">
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2 mb-6"><Settings className="text-indigo-500"/> 排班設定</h2>
                        <div className="grid grid-cols-2 gap-6 mb-8">
                            <div>
                                <label className="block text-sm font-bold text-slate-500 mb-2">年份</label>
                                <input type="number" value={year} onChange={e => setYear(parseInt(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 font-bold focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-500 mb-2">季度</label>
                                <select value={quarter} onChange={e => setQuarter(parseInt(e.target.value))} className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 font-bold focus:border-indigo-500 outline-none">
                                    <option value={1}>Q1 (1-3月)</option><option value={2}>Q2 (4-6月)</option><option value={3}>Q3 (7-9月)</option><option value={4}>Q4 (10-12月)</option>
                                </select>
                            </div>
                        </div>
                        <div className="mb-8">
                            <label className="block text-sm font-bold text-slate-500 mb-2">堂別</label>
                            <div className="flex gap-4">
                                {['第一堂', '第二堂'].map(s => (
                                    <label key={s} className="flex items-center gap-2 cursor-pointer bg-slate-50 px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-100">
                                        <input type="checkbox" checked={sessionsToSchedule.includes(s)} onChange={(e) => { if (e.target.checked) setSessionsToSchedule([...sessionsToSchedule, s]); else setSessionsToSchedule(sessionsToSchedule.filter(x => x !== s)); }} className="w-4 h-4 text-indigo-600 rounded" />
                                        <span className="font-bold text-slate-700">{s}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <button onClick={runAutoSchedule} disabled={isLoading || sessionsToSchedule.length === 0} className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white font-bold py-5 rounded-3xl flex items-center justify-center gap-2 shadow-xl shadow-indigo-100 transition-all active:scale-95">
                            {isLoading ? <RefreshCw className="animate-spin" /> : <><Play size={20}/> 產出自動排班表</>}
                        </button>
                    </div>
                </div>
            );

            const renderStep2 = () => {
                const tableData = {};
                generatedDraft.forEach(d => {
                    const key = `${d.service_date}_${d.session}`;
                    if (!tableData[key]) tableData[key] = { date: d.service_date, session: d.session, positions: {} };
                    if (!tableData[key].positions[d._positionName]) tableData[key].positions[d._positionName] = [];
                    tableData[key].positions[d._positionName].push(d);
                });
                const sortedRows = Object.values(tableData).sort((a, b) => a.session !== b.session ? a.session.localeCompare(b.session) : a.date.localeCompare(b.date));

                return (
                    <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 animate-step">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><LayoutList className="text-emerald-500"/> 排班預覽</h2>
                            <div className="flex items-center gap-2 text-[10px] text-slate-400 bg-slate-50 px-3 py-1 rounded-full uppercase font-bold tracking-tighter">
                                拖曳調整順序 • 點擊更換人選
                            </div>
                        </div>
                        <div className="overflow-x-auto border border-slate-100 rounded-[1.5rem] mb-8 shadow-inner">
                            <table className="w-full schedule-table border-collapse min-w-[1100px]">
                                <thead>
                                    <tr>
                                        <th className="sticky left-0 bg-slate-100 z-10 w-24">堂別</th><th className="w-32">日期</th>
                                        <th>司會</th><th>執事</th><th>接待</th><th>收奉獻</th><th className="bg-emerald-50/50">主餐</th><th>PPT</th><th>新朋友關懷</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedRows.map((row, idx) => (
                                        <tr key={idx} className="hover:bg-slate-50/50 transition-colors group">
                                            <td className="font-bold text-indigo-700 sticky left-0 bg-white group-hover:bg-slate-50 border-r">{row.session}</td>
                                            <td className="whitespace-nowrap font-medium text-slate-500">{row.date}</td>
                                            {['司會', '執事輪值', '接待', '收奉獻', '主餐', 'PPT', '新朋友關懷'].map(posName => (
                                                <td key={posName} className={posName === '主餐' ? 'bg-emerald-50/20' : ''}>
                                                    <div className="flex flex-wrap gap-1 min-h-[34px]">
                                                        {row.positions[posName]?.map((item, i) => (
                                                            <div 
                                                                key={item.temp_id}
                                                                draggable
                                                                onDragStart={(e) => handleDragStart(e, item)}
                                                                onDragEnd={handleDragEnd}
                                                                onDragOver={(e) => e.preventDefault()}
                                                                onDrop={(e) => handleDrop(e, row.date, row.session, posName, i)}
                                                                onClick={() => setActiveSlot(item)}
                                                                className="name-tag"
                                                            >
                                                                {item._memberName}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setStep(1)} className="w-1/3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-2xl transition-all">返回設定</button>
                            <button onClick={saveToDatabase} disabled={isSaving} className="w-2/3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-xl shadow-emerald-100 transition-all active:scale-95">
                                {isSaving ? <RefreshCw className="animate-spin" /> : <><Save size={20}/> 確定無誤，覆寫資料庫</>}
                            </button>
                        </div>
                    </div>
                );
            };

            const CandidateModal = () => {
                const candidates = useMemo(() => getRecommendations(activeSlot), [activeSlot]);
                if (!activeSlot) return null;

                return (
                    <div className="modal-backdrop" onClick={() => setActiveSlot(null)}>
                        <div className="modal-content" onClick={e => e.stopPropagation()}>
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <div>
                                    <h3 className="text-xl font-black text-slate-800 flex items-center gap-2"><UserCheck className="text-indigo-600" /> 更換替代人選</h3>
                                    <p className="text-xs text-slate-400 mt-1">{activeSlot.service_date} • {activeSlot.session} • {activeSlot._positionName}</p>
                                </div>
                                <button onClick={() => setActiveSlot(null)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={20}/></button>
                            </div>
                            <div className="max-h-[60vh] overflow-y-auto p-4 space-y-3">
                                <div className="text-[10px] font-bold text-slate-400 px-2 flex items-center gap-1"><Search size={12}/> 推薦系統分析 (具備職能、無衝突、低頻率)</div>
                                {candidates.length > 0 ? (
                                    candidates.map((c, idx) => (
                                        <div 
                                            key={c.id} 
                                            onClick={() => replaceMember(c)}
                                            className="flex items-center justify-between p-4 bg-slate-50 border border-slate-100 rounded-2xl cursor-pointer hover:border-indigo-300 hover:bg-indigo-50/50 transition-all group"
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-white shadow-sm ${idx < 3 ? 'bg-indigo-500' : 'bg-slate-300'}`}>{idx + 1}</div>
                                                <div>
                                                    <p className="font-bold text-slate-800 text-lg">{c.name}</p>
                                                    <p className="text-[10px] text-slate-400 flex items-center gap-1 font-medium"><Clock size={10}/> 本季已服事 {c.usage} 次</p>
                                                </div>
                                            </div>
                                            <div className="opacity-0 group-hover:opacity-100 transition-opacity bg-indigo-600 text-white p-2 rounded-xl"><ChevronRight size={16}/></div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="py-12 text-center text-slate-400">
                                        <HandHeart className="mx-auto mb-4 opacity-20" size={48} />
                                        <p className="font-bold">找不到合適的替代人選</p>
                                        <p className="text-xs mt-1 px-10">請確認該時段同工是否都已有班或請假</p>
                                    </div>
                                )}
                            </div>
                            <div className="p-4 bg-slate-50 border-t border-slate-100 text-center text-[10px] text-slate-400 font-medium">目前的同工：{activeSlot._memberName}</div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 py-12 px-4">
                    <CandidateModal />
                    <div className="max-w-[1300px] mx-auto">
                        <header className="text-center mb-10"><h1 className="text-3xl font-black text-slate-800 flex items-center justify-center gap-3"><Users className="text-indigo-600"/> TBC 自動排班系統</h1></header>
                        <div className="flex items-center justify-center gap-4 mb-8">
                            {[1, 2, 3].map(num => (
                                <div key={num} className="flex items-center gap-4">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black transition-all ${step >= num ? 'bg-indigo-600 text-white scale-110 shadow-lg shadow-indigo-100' : 'bg-slate-200 text-slate-400'}`}>{num}</div>
                                    {num < 3 && <ChevronRight className={`transition-colors ${step > num ? 'text-indigo-600' : 'text-slate-300'}`} />}
                                </div>
                            ))}
                        </div>
                        {errorMsg && <div className="max-w-3xl mx-auto bg-slate-800 text-white p-4 rounded-2xl flex items-center gap-3 mb-6 font-bold"><Info className="text-indigo-400" /> {errorMsg}</div>}
                        <div>{step === 1 && renderStep1()}{step === 2 && renderStep2()}{step === 3 && (
                            <div className="bg-white p-12 rounded-[3rem] shadow-sm border border-slate-200 text-center animate-step">
                                <div className="w-24 h-24 bg-emerald-100 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle2 size={48} /></div>
                                <h2 className="text-3xl font-black text-slate-800 mb-2">排班更新完成！</h2>
                                <p className="text-slate-500 mb-8 font-medium">資料庫已成功寫入，同工查詢系統將同步更新。</p>
                                <button onClick={() => window.location.reload()} className="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-10 rounded-2xl transition-all active:scale-95">完成</button>
                            </div>
                        )}</div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
